<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>MAP estimation Â· CMBLensing.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link href="../assets/cmblensing.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">CMBLensing.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">CMBLensing.jl</a></li><li><a class="tocitem" href="../01_lense_a_map/">Lensing a flat-sky map</a></li><li><a class="tocitem" href="../02_posterior/">The Lensing Posterior</a></li><li class="is-active"><a class="tocitem" href>MAP estimation</a><ul class="internal"><li><a class="tocitem" href="#Compute-spectra-1"><span>Compute spectra</span></a></li><li><a class="tocitem" href="#Configure-the-type-of-data-1"><span>Configure the type of data</span></a></li><li><a class="tocitem" href="#Generate-simulated-data-1"><span>Generate simulated data</span></a></li><li><a class="tocitem" href="#Examine-simulated-data-1"><span>Examine simulated data</span></a></li><li class="toplevel"><a class="tocitem" href="#Run-the-optimizer-1"><span>Run the optimizer</span></a></li><li class="toplevel"><a class="tocitem" href="#Examine-results-1"><span>Examine results</span></a></li></ul></li><li><a class="tocitem" href="../04_from_python/">Calling from Python</a></li><li><a class="tocitem" href="../05_field_basics/">Field Basics</a></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"></nav><div class="docs-right"><a class="docs-right" href="https://mybinder.org/v2/gh/marius311/CMBLensing.jl/actions?urlpath=lab/tree/03_joint_MAP_example.ipynb"><img src="https://mybinder.org/badge_logo.svg"/></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="MAP-estimation-1"><a class="docs-heading-anchor" href="#MAP-estimation-1">MAP estimation</a><a class="docs-heading-anchor-permalink" href="#MAP-estimation-1" title="Permalink"></a></h1><p>Here, we give an example of how to compute the joint maximum a posteriori (MAP) estimate of the CMB temperature and polarization fields, <span>$f$</span>, and the lensing potential, <span>$\phi$</span>.</p><pre class="language-julia"><code class="language-julia">using CMBLensing, PyPlot</code></pre><h2 id="Compute-spectra-1"><a class="docs-heading-anchor" href="#Compute-spectra-1">Compute spectra</a><a class="docs-heading-anchor-permalink" href="#Compute-spectra-1" title="Permalink"></a></h2><p>First, we compute the fiducial CMB power spectra which generate our simulated data,</p><pre class="language-julia"><code class="language-julia">Câ„“ = camb(r=0.05);</code></pre><p>Next, we chose the noise power-spectra:</p><pre class="language-julia"><code class="language-julia">Câ„“n = noiseCâ„“s(Î¼KarcminT=1, â„“knee=100);</code></pre><p>Plot these up for reference,</p><pre class="language-julia"><code class="language-julia">loglog(Câ„“.total.BB,c=&quot;C0&quot;)
loglog(Câ„“.unlensed_total.BB,&quot;--&quot;,c=&quot;C0&quot;)
loglog(Câ„“.total.EE,c=&quot;C1&quot;)
loglog(Câ„“.unlensed_total.EE,&quot;--&quot;,c=&quot;C1&quot;)
loglog(Câ„“n.BB,&quot;k:&quot;)
legend([&quot;lensed B&quot;,&quot;unlensed B&quot;,&quot;lensed E&quot;,&quot;unlensed E&quot;, &quot;noise (beam not deconvolved)&quot;]);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_9_0.png" alt="png"/></p><h2 id="Configure-the-type-of-data-1"><a class="docs-heading-anchor" href="#Configure-the-type-of-data-1">Configure the type of data</a><a class="docs-heading-anchor-permalink" href="#Configure-the-type-of-data-1" title="Permalink"></a></h2><p>These describe the setup of the simulated data we are going to work with (and can be changed in this notebook),</p><pre class="language-julia"><code class="language-julia">Î¸pix  = 3        # pixel size in arcmin
Nside = 128      # number of pixels per side in the map
pol   = :P       # type of data to use (can be :T, :P, or :TP)
T     = Float32  # data type (Float32 is ~2 as fast as Float64);</code></pre><h2 id="Generate-simulated-data-1"><a class="docs-heading-anchor" href="#Generate-simulated-data-1">Generate simulated data</a><a class="docs-heading-anchor-permalink" href="#Generate-simulated-data-1" title="Permalink"></a></h2><p>With these defined, the following generates the simulated data and returns the true unlensed and lensed CMB fields, <code>f</code> and <code>fÌƒ</code> ,and the true lensing potential, <code>Ï•</code>, as well as a number of other quantities stored in the &quot;DataSet&quot; object <code>ds</code>. </p><pre class="language-julia"><code class="language-julia">@unpack f, fÌƒ, Ï•, ds = load_sim_dataset(
    seed = 3,
    Câ„“ = Câ„“,
    Câ„“n = Câ„“n,
    Î¸pix = Î¸pix,
    T = T,
    Nside = Nside,
    pol = pol,
)

@unpack Cf, CÏ• = ds;</code></pre><h2 id="Examine-simulated-data-1"><a class="docs-heading-anchor" href="#Examine-simulated-data-1">Examine simulated data</a><a class="docs-heading-anchor-permalink" href="#Examine-simulated-data-1" title="Permalink"></a></h2><p>The true <span>$\phi$</span> map,</p><pre class="language-julia"><code class="language-julia">plot(Ï•, title = raw&quot;true $\phi$&quot;);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_18_0.png" alt="png"/></p><p>The &quot;true&quot; unlensed field, <span>$f$</span>,</p><pre class="language-julia"><code class="language-julia">plot(f, title = &quot;true unlensed &quot; .* [&quot;E&quot; &quot;B&quot;]);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_20_0.png" alt="png"/></p><p>And the &quot;true&quot; lensed field,</p><pre class="language-julia"><code class="language-julia">plot(LenseFlow(Ï•)*f, title = &quot;true lensed &quot; .* [&quot;E&quot; &quot;B&quot;]);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_22_0.png" alt="png"/></p><p>The data (stored in the <code>ds</code> object) is basically <code>fÌƒ</code> with a beam applied plus a sample of the noise,</p><pre class="language-julia"><code class="language-julia">plot(ds.d, title = &quot;data &quot; .* [&quot;E&quot; &quot;B&quot;]);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_24_0.png" alt="png"/></p><h1 id="Run-the-optimizer-1"><a class="docs-heading-anchor" href="#Run-the-optimizer-1">Run the optimizer</a><a class="docs-heading-anchor-permalink" href="#Run-the-optimizer-1" title="Permalink"></a></h1><p>Now we compute the maximum of the joint posterior, <span>$\mathcal{P}\big(f, \phi \,\big|\,d\big)$</span></p><pre class="language-julia"><code class="language-julia">@time fbf, Ï•bf, tr = MAP_joint(ds, nsteps=30, progress=:verbose, Î±max=0.1);</code></pre><pre class="language-output"><code class="language-output">(step=1, Ï‡Â²=43836.26, Ncg=2)
(step=2, Ï‡Â²=38474.92, Ncg=9, Î±=0.012516)
(step=3, Ï‡Â²=36237.41, Ncg=8, Î±=0.026335)
(step=4, Ï‡Â²=35665.59, Ncg=9, Î±=0.018166)
(step=5, Ï‡Â²=35276.94, Ncg=8, Î±=0.020261)
(step=6, Ï‡Â²=35017.95, Ncg=8, Î±=0.017005)
(step=7, Ï‡Â²=34791.74, Ncg=8, Î±=0.022454)
(step=8, Ï‡Â²=34639.82, Ncg=8, Î±=0.015196)
(step=9, Ï‡Â²=34469.41, Ncg=7, Î±=0.029120)
(step=10, Ï‡Â²=34367.64, Ncg=7, Î±=0.012310)
(step=11, Ï‡Â²=34160.93, Ncg=7, Î±=0.061112)
(step=12, Ï‡Â²=34071.91, Ncg=7, Î±=0.009033)
(step=13, Ï‡Â²=33863.61, Ncg=7, Î±=0.099927)
(step=14, Ï‡Â²=33814.76, Ncg=7, Î±=0.008878)
(step=15, Ï‡Â²=33713.26, Ncg=7, Î±=0.099927)
(step=16, Ï‡Â²=33676.56, Ncg=6, Î±=0.008476)
(step=17, Ï‡Â²=33642.58, Ncg=7, Î±=0.053620)
(step=18, Ï‡Â²=33623.77, Ncg=6, Î±=0.009566)
(step=19, Ï‡Â²=33562.09, Ncg=5, Î±=0.099927)
(step=20, Ï‡Â²=33552.98, Ncg=5, Î±=0.017336)
(step=21, Ï‡Â²=33542.84, Ncg=5, Î±=0.025802)
(step=22, Ï‡Â²=33535.12, Ncg=5, Î±=0.014655)
(step=23, Ï‡Â²=33523.35, Ncg=5, Î±=0.039226)
(step=24, Ï‡Â²=33515.93, Ncg=5, Î±=0.010942)
(step=25, Ï‡Â²=33487.38, Ncg=5, Î±=0.099927)
(step=26, Ï‡Â²=33482.33, Ncg=5, Î±=0.010927)
(step=27, Ï‡Â²=33462.80, Ncg=5, Î±=0.099927)
(step=28, Ï‡Â²=33459.02, Ncg=4, Î±=0.010107)
(step=29, Ï‡Â²=33443.73, Ncg=4, Î±=0.099927)
(step=30, Ï‡Â²=33441.00, Ncg=4, Î±=0.027225)
 59.888361 seconds (58.26 M allocations: 9.533 GiB, 2.98% gc time)</code></pre><h1 id="Examine-results-1"><a class="docs-heading-anchor" href="#Examine-results-1">Examine results</a><a class="docs-heading-anchor-permalink" href="#Examine-results-1" title="Permalink"></a></h1><p>The expected value of the final best-fit <span>$\chi^2 (=-2\log \mathcal{P}$</span>) is given by the number degrees of freedom in the data, i.e. the total number of pixels in T and/or EB.</p><pre class="language-julia"><code class="language-julia">Ï‡Â² = -2tr[end][:lnPcur]</code></pre><pre class="language-output"><code class="language-output">33440.996f0</code></pre><pre class="language-julia"><code class="language-julia">dof = length(Map(f)[:])</code></pre><pre class="language-output"><code class="language-output">32768</code></pre><p>Here&#39;s how far away our final <span>$\chi^2$</span> is from this expectation, in units of <span>$\sigma$</span>. We expect this should be somewhere in the range (-3,3) for about 99.7% of simulated datasets.</p><pre class="language-julia"><code class="language-julia">(Ï‡Â² - dof)/sqrt(2dof)</code></pre><pre class="language-output"><code class="language-output">2.6288909912109375</code></pre><p>Here&#39;s the best-fit <span>$\phi$</span> relative to the truth,</p><pre class="language-julia"><code class="language-julia">plot(10^6*[Ï• Ï•bf], title=[&quot;true&quot; &quot;best-fit&quot;] .* raw&quot; $\phi$&quot;, vlim=17);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_35_0.png" alt="png"/></p><p>Here is the difference in terms of the power spectra. Note the best-fit has high-<span>$\ell$</span> power suppressed, like a Wiener filter solution (in fact what we&#39;re doing here is akin to a non-linear Wiener filter). In the high S/N region (<span>$\ell\lesssim1000$</span>), the difference is approixmately equal to the noise, which you can see is almost two orders of magnitude below the signal.</p><pre class="language-julia"><code class="language-julia">â„“edges = 100:200:3000</code></pre><pre class="language-output"><code class="language-output">100:200:2900</code></pre><pre class="language-julia"><code class="language-julia">semilogx(get_Ïâ„“(Ï•bf,Ï•))</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_38_0.png" alt="png"/></p><pre class="language-output"><code class="language-output">1-element Array{PyCall.PyObject,1}:
 PyObject &lt;matplotlib.lines.Line2D object at 0x7ff1f7d18c18&gt;</code></pre><pre class="language-julia"><code class="language-julia">(1 / get_Ïâ„“(Ï•bf,Ï•)^2 - 1)</code></pre><pre class="language-output"><code class="language-output">InterpolatedCâ„“s{Float32,CMBLensing.var&quot;#38#39&quot;{Float64,Array{Float32,1},Array{Float32,1},Array{Float32,1}}}(CMBLensing.var&quot;#38#39&quot;{Float64,Array{Float32,1},Array{Float32,1},Array{Float32,1}}(NaN, Float32[69.883934, 121.674126, 171.2532, 223.09958, 275.13376, 325.91238, 378.15732, 421.16135, 466.86844, 518.24414  â€¦  4620.758, 4674.4834, 4729.9565, 4776.6157, 4815.539, 4872.467, 4933.0317, 4972.4272, 5011.935, 5059.5244], Float32[0.025821567, 0.01847291, 0.03158164, 0.048185825, 0.04714632, 0.069004536, 0.22774446, 0.14895427, 0.17769814, 0.14428484  â€¦  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0], Float32[-0.00014189283, 0.00026440044, 0.0003202574, -1.997735f-5, 0.00043046096, 0.0030383794, -0.0018321583, 0.00062887097, -0.0006503715, 0.0029763351  â€¦  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]), true)</code></pre><pre class="language-julia"><code class="language-julia"></code></pre><pre class="language-julia"><code class="language-julia">chain = sample_joint(
    ds,
    symp_kwargs = [(N=25, Ïµ=0.05)],
    nsamps_per_chain = 100,
    nchains = 1, 
    nburnin_always_accept = Inf,
    progress = :summary
);</code></pre><pre class="language-output"><code class="language-output">[32mGibbs chain: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| Time: 0:06:26[39m</code></pre><pre class="language-julia"><code class="language-julia">get_Ïâ„“(Ï•,Ï•bf,â„“edges=100:50:3000)</code></pre><pre class="language-output"><code class="language-output">InterpolatedCâ„“s{Float32,CMBLensing.var&quot;#38#39&quot;{Float64,Array{Float32,1},Array{Float32,1},Array{Float32,1}}}(CMBLensing.var&quot;#38#39&quot;{Float64,Array{Float32,1},Array{Float32,1},Array{Float32,1}}(NaN, Float32[121.674126, 171.2532, 223.09958, 275.13376, 325.91238, 378.15732, 421.16135, 466.86844, 518.24414, 572.7766  â€¦  2528.3518, 2577.3535, 2626.5024, 2672.5356, 2722.9412, 2776.0034, 2826.1594, 2875.541, 2926.273, 2976.9487], Float32[0.9908896, 0.9845736, 0.97674423, 0.97722894, 0.9671865, 0.90249753, 0.93292904, 0.92147386, 0.9348306, 0.8748428  â€¦  Inf, Inf, Inf, Inf, Inf, Inf, Inf, Inf, Inf, Inf], Float32[-0.00012739257, -0.00015101091, 9.315127f-6, -0.00019776882, -0.0012381866, 0.0007076432, -0.00025062147, 0.00025998175, -0.0011000378, 0.00018945953  â€¦  NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN]), true)</code></pre><pre class="language-julia"><code class="language-julia">plot(Ï•bf, which=:Il)</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_43_0.png" alt="png"/></p><pre class="language-julia"><code class="language-julia">loglog(â„“â´*Câ„“.total.Ï•Ï•)
loglog(â„“â´*Câ„“.total.Ï•Ï• * (1 / get_Ïâ„“(Ï•bf,Ï•,Î”â„“=25)^2 - 1))</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_44_0.png" alt="png"/></p><pre class="language-output"><code class="language-output">1-element Array{PyCall.PyObject,1}:
 PyObject &lt;matplotlib.lines.Line2D object at 0x7ff1f7d6cf98&gt;</code></pre><pre class="language-julia"><code class="language-julia">loglog(â„“â´ * Câ„“.total.Ï•Ï•, &quot;k&quot;)
loglog(get_â„“â´Câ„“(Ï•))
loglog(get_â„“â´Câ„“(Ï•bf))
loglog(get_â„“â´Câ„“(Ï•bf-Ï•))
xlim(80,3000)
ylim(5e-9,2e-6)
legend([&quot;theory&quot;,raw&quot;true $\phi$&quot;, raw&quot;best-fit $\phi$&quot;, &quot;difference&quot;])
xlabel(raw&quot;$\ell$&quot;)
ylabel(raw&quot;$\ell^4 C_\ell$&quot;);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_45_0.png" alt="png"/></p><p>The best-fit unlensed fields relative to truth,</p><pre class="language-julia"><code class="language-julia">plot([f,fbf], title = [&quot;true&quot;, &quot;best-fit&quot;] .* &quot; unlensed &quot; .* [&quot;E&quot; &quot;B&quot;]);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_47_0.png" alt="png"/></p><p>The best-fit lensed field (bottom row) relative to truth (top row),</p><pre class="language-julia"><code class="language-julia">plot([fÌƒ, LenseFlow(Ï•bf)*fbf], title = [&quot;true&quot;, &quot;best-fit&quot;] .* &quot; lensed &quot; .* [&quot;E&quot; &quot;B&quot;]);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_49_0.png" alt="png"/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../02_posterior/">Â« The Lensing Posterior</a><a class="docs-footer-nextpage" href="../04_from_python/">Calling from Python Â»</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Monday 6 April 2020 06:54">Monday 6 April 2020</span>. Using Julia version 1.4.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
