<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>The Lensing Posterior · CMBLensing.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/cmblensing.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">CMBLensing.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">CMBLensing.jl</a></li><li><a class="tocitem" href="../01_lense_a_map/">Lensing a flat-sky map</a></li><li class="is-active"><a class="tocitem" href>The Lensing Posterior</a><ul class="internal"><li><a class="tocitem" href="#Posterior-basics"><span>Posterior basics</span></a></li><li><a class="tocitem" href="#Wiener-filtering"><span>Wiener filtering</span></a></li><li><a class="tocitem" href="#Posterior-gradients"><span>Posterior gradients</span></a></li></ul></li><li><a class="tocitem" href="../03_joint_MAP_example/">MAP estimation</a></li><li><a class="tocitem" href="../04_from_python/">Calling from Python</a></li><li><a class="tocitem" href="../05_field_basics/">Field Basics</a></li><li><a class="tocitem" href="../06_gpu/">GPU</a></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"></nav><div class="docs-right"><a class="docs-right" href="https://mybinder.org/v2/gh/marius311/CMBLensing.jl/gh-pages?urlpath=lab/tree/02_posterior.ipynb"><img src="https://mybinder.org/badge_logo.svg"/></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="The-Lensing-Posterior"><a class="docs-heading-anchor" href="#The-Lensing-Posterior">The Lensing Posterior</a><a id="The-Lensing-Posterior-1"></a><a class="docs-heading-anchor-permalink" href="#The-Lensing-Posterior" title="Permalink"></a></h1><p>At its heart, CMBLensing.jl is centered around the &quot;CMB lensing posterior&quot;. We work with both the &quot;<strong>joint posterior</strong>&quot;, which is joint over all variables,</p><p class="math-container">\[ \mathcal{P}(f,\phi,\theta\,|\,d), \]</p><p>or the &quot;<strong>marginal posterior</strong>&quot;, </p><p class="math-container">\[ \mathcal{P}(\phi,\theta\,|\,d) \equiv \int \! \mathcal{D}f \; \mathcal{P}(f,\phi,\theta\,|\,d), \]</p><p>which is simply the joint posterior analytically marginalized over <span>$f$</span>. Here,</p><ul><li><span>$f$</span> are the CMB fields (T/Q/U),</li><li><span>$\phi$</span> is the lensing potential,</li><li><span>$\theta$</span> are any cosmological parameters,</li><li><span>$d$</span> is the data.</li></ul><p>The default data model which is assumed, which is generally flexible enough to handle real experiments (but can be customized), is:</p><p class="math-container">\[ d =  \mathbb{A} \, \mathbb{L}(\phi) \, f + n, \]</p><p>where</p><p class="math-container">\[ \mathbb{A} = \mathbb{M} \, \mathbb{B} \]</p><p>and </p><ul><li><span>$\mathbb{L}(\phi)$</span> is the lensing operation</li><li><span>$\mathbb{B}$</span> is an instrumental transfer function or &quot;beam&quot;</li><li><span>$\mathbb{M}$</span> is a user-chosen mask</li><li><span>$n$</span> is the instrumental noise. </li></ul><p>Given this model, the joint posterior (up to an unimportant normalization constant) is:</p><p class="math-container">\[ 
-2\ln\mathcal{P}(f,\phi,\theta\,|\,d) = \frac{\big(d - \mathbb{A} \, \mathbb{L}(\phi) \, f\big)^2}{\mathbb{C}_n}
+ \frac{f^2}{\mathbb{C}_f(\theta)} + \frac{\phi^2}{C_\phi(\theta)} + \log\det \mathbb{C}_f(\theta) + \log\det C_\phi(\theta),
\]</p><p>and the marginal posterior is:</p><p class="math-container">\[ 
-2\ln\mathcal{P}(\phi,\theta\,|\,d) = \frac{d^2}{\mathbb{\Sigma}_d(\phi,\theta)} + \frac{\phi^2}{C_\phi(\theta)} + \log\det \mathbb{\Sigma}_d(\phi,\theta) + \log\det C_\phi(\theta),
\]</p><p>where</p><p class="math-container">\[
\Sigma_d = \mathbb{A} \, \mathbb{L}(\phi) \, \mathbb{C}_f(\theta) \, \mathbb{L}(\phi)^\dagger \mathbb{A}^\dagger + \mathbb{C}_n
\]</p><p>and</p><ul><li><span>$\mathbb{C}_n$</span> is the noise covariance</li><li><span>$\mathbb{C}_f$</span> is the CMB covariance (i.e. the CMB T, E, and B <span>$C_\ell$</span>&#39;s)</li><li><span>$\mathbb{C}_\phi$</span> is the lensing potential covariance (i.e. <span>$C_\ell^{\phi\phi}$</span>)</li></ul><p>and we have used the slighly sloppy notation <span>$x^2/\mathbb{C}$</span> to mean <span>$x^\dagger \mathbb{C}^{-1} x$</span>.</p><h2 id="Posterior-basics"><a class="docs-heading-anchor" href="#Posterior-basics">Posterior basics</a><a id="Posterior-basics-1"></a><a class="docs-heading-anchor-permalink" href="#Posterior-basics" title="Permalink"></a></h2><pre><code class="language-julia hljs">using CMBLensing, PythonPlot</code></pre><p>CMBLensing uses the function <code>logpdf</code> to compute the log of the joint posterior probability. </p><p>To evaluate this posterior, we need the arguments of the probability distribution, <span>$f$</span>, <span>$\phi$</span>, and <span>$\theta$</span>. We also need the data <span>$d$</span> and host of other operators and covariances which enter the expressions above, which CMBLensing stores in a <code>DataSet</code> object.</p><p>First lets load up some simulated data. The function <code>load_sim</code> handles constructing a <code>DataSet</code> and is the recommended way to create the various fields and covariances needed. In this case, let&#39;s use 1<span>$\mu$</span>K-arcmin noise and a border mask:</p><pre><code class="language-julia hljs">(;f, f̃, ϕ, ds) = load_sim(
    θpix      = 2,
    Nside     = 256,
    T         = Float64,
    pol       = :P,
    μKarcminT = 1,
    L         = LenseFlow(10),
    seed      = 0,
    pixel_mask_kwargs = (edge_padding_deg=1, apodization_deg=0, num_ptsrcs=0),
    bandpass_mask     = LowPass(5000)
);</code></pre><p>The <code>DataSet</code> object, by convention called <code>ds</code>, stores all the aforementioned quantities:</p><pre><code class="language-julia hljs">fieldnames(typeof(ds))</code></pre><pre><code class="language-output hljs ansi">(:d, :Cf, :Cn, :Cn̂, :M, :M̂, :B, :B̂, :logprior, :Cϕ, :Cf̃, :D, :G, :L, :Nϕ)</code></pre><p>For example, the data is:</p><pre><code class="language-julia hljs">plot(ds.d);</code></pre><p><img src="../02_posterior_files/02_posterior_11_0.png" alt="png"/></p><p>Or the diagonal of the <span>$\mathbb{C}_f$</span> operator:</p><pre><code class="language-julia hljs">plot(diag(ds.Cf), which=[:El :Bl])</code></pre><p><img src="../02_posterior_files/02_posterior_13_0.png" alt="png"/></p><p>We can now evaluate the posterior, for example at the true <span>$f$</span> and <span>$\phi$</span>:</p><pre><code class="language-julia hljs">logpdf(ds; f, ϕ)</code></pre><pre><code class="language-output hljs ansi">1.6745891005256723e6</code></pre><p>There is a particular change-of-variables called the &quot;mixed parameterization&quot; (see <a href="https://arxiv.org/abs/2002.00965">our paper</a> for details) which helps make the the posterior a little less correlated and more amenable to sampling and maximization. We can apply the change-of-variables to some point in parameter space as:</p><pre><code class="language-julia hljs">f°, ϕ° = mix(ds; f, ϕ);</code></pre><p>Then we can evaluate the posterior in the mixed parameterization:</p><pre><code class="language-julia hljs">logpdf(Mixed(ds); f°, ϕ°)</code></pre><pre><code class="language-output hljs ansi">1.6745929299943913e6</code></pre><p>Note that this is the same value as above since we are just evaluating the same point in parameter space, just parameterized in terms of different variables.</p><p>Above, we didn&#39;t specify any cosmological parameters, <span>$\theta$</span>. Because of that, they were fixed at their fiducial values (i.e. the fiducial values which generated the simulated data in the call to <code>load_sim</code> earlier). Current only two parameters can be varied, <span>$r$</span> (tensor-to-scalar ratio), and <span>$A_\phi$</span> (the amplitude of <span>$C_\ell^{\phi \phi}$</span>). They can be specified as follows, with non-specified parameters left at their fiducial:</p><pre><code class="language-julia hljs">logpdf(ds; f, ϕ, θ=(Aϕ=1.1,))</code></pre><pre><code class="language-output hljs ansi">1.6744484549757265e6</code></pre><p>You can see the slight change compared to what we got above. We can even compute a whole slice through the posterior along <span>$A_\phi$</span>:</p><pre><code class="language-julia hljs">Aϕs = range(0.5,1.5,length=50)
plot(Aϕs, [logpdf(ds; f, ϕ, θ=(;Aϕ)) for Aϕ in Aϕs])
xlabel(raw&quot;$A_\phi$&quot;)
ylabel(raw&quot;$\log\mathcal{P}(f_{\rm true}, \phi_{\rm true}, A_\phi\,|\,d)$&quot;);</code></pre><p><img src="../02_posterior_files/02_posterior_24_0.png" alt="png"/></p><h2 id="Wiener-filtering"><a class="docs-heading-anchor" href="#Wiener-filtering">Wiener filtering</a><a id="Wiener-filtering-1"></a><a class="docs-heading-anchor-permalink" href="#Wiener-filtering" title="Permalink"></a></h2><p>If we fix <span>$\phi$</span> and <span>$\theta$</span> then maximize the joint posterior, <span>$\mathcal{P}(f,\phi,\theta\,|\,d)$</span>, over <span>$f$</span>, we get</p><p class="math-container">\[
\hat f_{\rm wf} = \big[ \mathbb{C}_f(\theta)^{-1} + \mathbb{L}(\phi)^\dagger \mathbb{A}^\dagger\mathbb{C}_n^{-1}\mathbb{A} \, \mathbb{L}(\phi) \big]^{-1} \mathbb{L}(\phi)^\dagger \mathbb{A}^\dagger\mathbb{C}_n^{-1}d
\]</p><p>This is simply the Wiener filter of the data given a signal covariance which includes correlations induced by <span>$\phi$</span>, and we can compute it by inverting the operator in brackets above with e.g. conjugate gradient. </p><p>In CMBLensing.jl, the <code>argmaxf_logpdf</code> function performs this task. Its arguments are similar to <code>logpdf</code>,</p><pre><code class="language-julia hljs">f_wf, = argmaxf_logpdf(ds, (;ϕ); conjgrad_kwargs=(tol=1e-1,progress=true));</code></pre><pre><code class="language-output hljs ansi"><span class="sgr32">Conjugate Gradient: 100%|███████████████████████████████| Time: 0:00:23</span></code></pre><p>Wiener filtering effectively delenses the data by a given <span>$\phi$</span>. Here we are Wiener filtering at the true <span>$\phi$</span>, so this is perfect delensing. Note below the large amount of B mode power in the data, as well as the aliasing near the border mask, and how this is removed in the Wiener filtered B, which visually is tracing the true B map up to the level of the noise.</p><pre><code class="language-julia hljs">plot([ds.d, f_wf, f], title=[&quot;data &quot;, &quot;Wiener filtered &quot;, &quot;true &quot;] .* [&quot;E&quot; &quot;B&quot;]);</code></pre><p><img src="../02_posterior_files/02_posterior_30_0.png" alt="png"/></p><h2 id="Posterior-gradients"><a class="docs-heading-anchor" href="#Posterior-gradients">Posterior gradients</a><a id="Posterior-gradients-1"></a><a class="docs-heading-anchor-permalink" href="#Posterior-gradients" title="Permalink"></a></h2><p>Fundamental to maximization and sampling algorithms in high dimensions are gradients of the posterior. CMBLensing.jl uses the interface provided by the automatic differentiation library <a href="https://github.com/FluxML/Zygote.jl/">Zygote</a> to compute these gradients.</p><pre><code class="language-julia hljs">using Zygote</code></pre><p>Zygote provides the <code>gradient</code> function, which takes a function for which to evaluate the gradient as the first argument, and the value at which to evaluate the gradient as the second argument. For example:</p><pre><code class="language-julia hljs">gradient(x-&gt;3x^2+2x, 1)</code></pre><pre><code class="language-output hljs ansi">(8.0,)</code></pre><p>Gradients of the CMB lensing posterior work in exactly the same way. For example, to take the gradient with respect to <span>$\phi$</span> in the mixed parametrization, where we fix <span>$f$</span> to the Wiener filter computed above and evaluate the gradient at <span>$\phi=0$</span>, we can do:</p><pre><code class="language-julia hljs">gϕ = gradient(ϕ° -&gt; logpdf(Mixed(ds); f°=f_wf, ϕ°), 0ϕ)[1];</code></pre><p>Here&#39;s what this gradient looks like multiplied by <span>$\mathbb{C}_\phi$</span>. This is actually the first gradient step in the iterative joint maximum a posteriori estimation. You can see below this very broadly matches the truth:</p><pre><code class="language-julia hljs">plot([ds.Cϕ*gϕ ϕ], title=[&quot;gradient step&quot; &quot;true ϕ&quot;])</code></pre><p><img src="../02_posterior_files/02_posterior_39_0.png" alt="png"/></p><p>You are free to manipulate the fields inside of the function whose gradient is being taken, and Zygote will automatically propagate the chain rule for you:</p><pre><code class="language-julia hljs">gradient(ϕ -&gt; -2logpdf(ds; f=f_wf, ϕ=3ϕ), 0ϕ)[1] ≈ -6 * gradient(ϕ -&gt; logpdf(ds; f=f_wf, ϕ), 0ϕ)[1]</code></pre><pre><code class="language-output hljs ansi">true</code></pre><p>Automatic differentiation with respect to any and all arguments of <code>logpdf</code> works, including the cosmological parameters:</p><pre><code class="language-julia hljs">gradient(Aϕ -&gt; logpdf(ds; f, ϕ, θ=(;Aϕ)), 1)</code></pre><pre><code class="language-output hljs ansi">(39.23843471356463,)</code></pre><p>Currently Zygote is working with many (but not all) operations that you can do to fields. If you run into things which Zygote is not able to differentiate successfully (generally you&#39;ll get some error), please feel free to file an <a href="https://github.com/marius311/CMBLensing.jl/issues">Issue</a> with CMBLensing.jl.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../01_lense_a_map/">« Lensing a flat-sky map</a><a class="docs-footer-nextpage" href="../03_joint_MAP_example/">MAP estimation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Thursday 20 April 2023 07:56">Thursday 20 April 2023</span>. Using Julia version 1.9.0-rc2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
