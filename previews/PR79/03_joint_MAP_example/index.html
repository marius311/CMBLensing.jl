<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>MAP estimation · CMBLensing.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.044/juliamono.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/cmblensing.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">CMBLensing.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">CMBLensing.jl</a></li><li><a class="tocitem" href="../01_lense_a_map/">Lensing a flat-sky map</a></li><li><a class="tocitem" href="../02_posterior/">The Lensing Posterior</a></li><li class="is-active"><a class="tocitem" href>MAP estimation</a><ul class="internal"><li><a class="tocitem" href="#Compute-spectra"><span>Compute spectra</span></a></li><li><a class="tocitem" href="#Configure-the-type-of-data"><span>Configure the type of data</span></a></li><li><a class="tocitem" href="#Generate-simulated-data"><span>Generate simulated data</span></a></li><li><a class="tocitem" href="#Examine-simulated-data"><span>Examine simulated data</span></a></li><li class="toplevel"><a class="tocitem" href="#Run-the-optimizer"><span>Run the optimizer</span></a></li><li class="toplevel"><a class="tocitem" href="#Examine-results"><span>Examine results</span></a></li></ul></li><li><a class="tocitem" href="../04_from_python/">Calling from Python</a></li><li><a class="tocitem" href="../05_field_basics/">Field Basics</a></li><li><a class="tocitem" href="../06_gpu/">GPU</a></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"></nav><div class="docs-right"><a class="docs-right" href="https://mybinder.org/v2/gh/marius311/CMBLensing.jl/gh-pages?urlpath=lab/tree/03_joint_MAP_example.ipynb"><img src="https://mybinder.org/badge_logo.svg"/></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="MAP-estimation"><a class="docs-heading-anchor" href="#MAP-estimation">MAP estimation</a><a id="MAP-estimation-1"></a><a class="docs-heading-anchor-permalink" href="#MAP-estimation" title="Permalink"></a></h1><p>Here, we give an example of how to compute the joint maximum a posteriori (MAP) estimate of the CMB temperature and polarization fields, <span>$f$</span>, and the lensing potential, <span>$\phi$</span>.</p><pre><code class="language-julia hljs">using CMBLensing, PyPlot</code></pre><h2 id="Compute-spectra"><a class="docs-heading-anchor" href="#Compute-spectra">Compute spectra</a><a id="Compute-spectra-1"></a><a class="docs-heading-anchor-permalink" href="#Compute-spectra" title="Permalink"></a></h2><p>First, we compute the fiducial CMB power spectra which generate our simulated data,</p><pre><code class="language-julia hljs">Cℓ = camb(r=0.05);</code></pre><p>Next, we chose the noise power-spectra:</p><pre><code class="language-julia hljs">Cℓn = noiseCℓs(μKarcminT=1, ℓknee=100);</code></pre><p>Plot these up for reference,</p><pre><code class="language-julia hljs">loglog(Cℓ.total.BB,c=&quot;C0&quot;)
loglog(Cℓ.unlensed_total.BB,&quot;--&quot;,c=&quot;C0&quot;)
loglog(Cℓ.total.EE,c=&quot;C1&quot;)
loglog(Cℓ.unlensed_total.EE,&quot;--&quot;,c=&quot;C1&quot;)
loglog(Cℓn.BB,&quot;k:&quot;)
legend([&quot;lensed B&quot;,&quot;unlensed B&quot;,&quot;lensed E&quot;,&quot;unlensed E&quot;, &quot;noise (beam not deconvolved)&quot;]);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_9_0.png" alt="png"/></p><h2 id="Configure-the-type-of-data"><a class="docs-heading-anchor" href="#Configure-the-type-of-data">Configure the type of data</a><a id="Configure-the-type-of-data-1"></a><a class="docs-heading-anchor-permalink" href="#Configure-the-type-of-data" title="Permalink"></a></h2><p>These describe the setup of the simulated data we are going to work with (and can be changed in this notebook),</p><pre><code class="language-julia hljs">θpix  = 3        # pixel size in arcmin
Nside = 128      # number of pixels per side in the map
pol   = :P       # type of data to use (can be :T, :P, or :TP)
T     = Float32  # data type (Float32 is ~2 as fast as Float64);</code></pre><h2 id="Generate-simulated-data"><a class="docs-heading-anchor" href="#Generate-simulated-data">Generate simulated data</a><a id="Generate-simulated-data-1"></a><a class="docs-heading-anchor-permalink" href="#Generate-simulated-data" title="Permalink"></a></h2><p>With these defined, the following generates the simulated data and returns the true unlensed and lensed CMB fields, <code>f</code> and <code>f̃</code> ,and the true lensing potential, <code>ϕ</code>, as well as a number of other quantities stored in the &quot;DataSet&quot; object <code>ds</code>. </p><pre><code class="language-julia hljs">@unpack f, f̃, ϕ, ds = load_sim(
    seed = 3,
    Cℓ = Cℓ,
    Cℓn = Cℓn,
    θpix = θpix,
    T = T,
    Nside = Nside,
    pol = pol,
)

@unpack Cf, Cϕ = ds;</code></pre><h2 id="Examine-simulated-data"><a class="docs-heading-anchor" href="#Examine-simulated-data">Examine simulated data</a><a id="Examine-simulated-data-1"></a><a class="docs-heading-anchor-permalink" href="#Examine-simulated-data" title="Permalink"></a></h2><p>The true <span>$\phi$</span> map,</p><pre><code class="language-julia hljs">plot(ϕ, title = raw&quot;true $\phi$&quot;);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_18_0.png" alt="png"/></p><p>The &quot;true&quot; unlensed field, <span>$f$</span>,</p><pre><code class="language-julia hljs">plot(f, title = &quot;true unlensed &quot; .* [&quot;E&quot; &quot;B&quot;]);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_20_0.png" alt="png"/></p><p>And the &quot;true&quot; lensed field,</p><pre><code class="language-julia hljs">plot(LenseFlow(ϕ)*f, title = &quot;true lensed &quot; .* [&quot;E&quot; &quot;B&quot;]);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_22_0.png" alt="png"/></p><p>The data (stored in the <code>ds</code> object) is basically <code>f̃</code> with a beam applied plus a sample of the noise,</p><pre><code class="language-julia hljs">plot(ds.d, title = &quot;data &quot; .* [&quot;E&quot; &quot;B&quot;]);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_24_0.png" alt="png"/></p><h1 id="Run-the-optimizer"><a class="docs-heading-anchor" href="#Run-the-optimizer">Run the optimizer</a><a id="Run-the-optimizer-1"></a><a class="docs-heading-anchor-permalink" href="#Run-the-optimizer" title="Permalink"></a></h1><p>Now we compute the maximum of the joint posterior, <span>$\mathcal{P}\big(f, \phi \,\big|\,d\big)$</span></p><pre><code class="language-julia hljs">fJ, ϕJ, history = MAP_joint(ds, nsteps=30, progress=true);</code></pre><pre><code class="language-output hljs ansi"><span class="sgr32">MAP_joint: 100%|████████████████████████████████████████| Time: 0:01:41</span>
<span class="sgr34">  step:        30</span>
<span class="sgr34">  logpdf:      405058.62</span>
<span class="sgr34">  α:           0.036326826</span>
<span class="sgr34">  CG:          2 iterations</span>
<span class="sgr34">  Linesearch:  12 bisections</span></code></pre><h1 id="Examine-results"><a class="docs-heading-anchor" href="#Examine-results">Examine results</a><a id="Examine-results-1"></a><a class="docs-heading-anchor-permalink" href="#Examine-results" title="Permalink"></a></h1><p>The <code>history</code> variable gives some info about the run, and more info can be saved by passing <code>history_keys</code> argument to <a href="api/#CMBLensing.MAP_joint"><code>MAP_joint</code></a>. By default, we get just the value of the posterior, which we can use to check the maximizer has asymptoted to a maximum value:</p><pre><code class="language-julia hljs">plot(getindex.(history, :logpdf))
xlabel(&quot;step&quot;)
ylabel(&quot;logpdf&quot;);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_30_0.png" alt="png"/></p><p>Here&#39;s the best-fit <span>$\phi$</span> relative to the truth,</p><pre><code class="language-julia hljs">plot(10^6*[ϕ ϕJ], title=[&quot;true&quot; &quot;best-fit&quot;] .* raw&quot; $\phi$&quot;, vlim=17);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_32_0.png" alt="png"/></p><p>Here is the difference in terms of the power spectra. Note the best-fit has high-<span>$\ell$</span> power suppressed, like a Wiener filter solution (in fact what we&#39;re doing here is akin to a non-linear Wiener filter). In the high S/N region (<span>$\ell\lesssim1000$</span>), the difference is approixmately equal to the noise, which you can see is almost two orders of magnitude below the signal.</p><pre><code class="language-julia hljs">loglog(ℓ⁴ * Cℓ.total.ϕϕ, &quot;k&quot;)
loglog(get_ℓ⁴Cℓ(ϕ))
loglog(get_ℓ⁴Cℓ(ϕJ))
loglog(get_ℓ⁴Cℓ(ϕJ-ϕ))
xlim(80,3000)
ylim(5e-9,2e-6)
legend([&quot;theory&quot;,raw&quot;true $\phi$&quot;, raw&quot;best-fit $\phi$&quot;, &quot;difference&quot;])
xlabel(raw&quot;$\ell$&quot;)
ylabel(raw&quot;$\ell^4 C_\ell$&quot;);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_34_0.png" alt="png"/></p><p>The best-fit unlensed fields relative to truth,</p><pre><code class="language-julia hljs">plot([f,fJ], title = [&quot;true&quot;, &quot;best-fit&quot;] .* &quot; unlensed &quot; .* [&quot;E&quot; &quot;B&quot;]);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_36_0.png" alt="png"/></p><p>The best-fit lensed field (bottom row) relative to truth (top row),</p><pre><code class="language-julia hljs">plot([f̃, LenseFlow(ϕJ)*fJ], title = [&quot;true&quot;, &quot;best-fit&quot;] .* &quot; lensed &quot; .* [&quot;E&quot; &quot;B&quot;]);</code></pre><p><img src="../03_joint_MAP_example_files/03_joint_MAP_example_38_0.png" alt="png"/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../02_posterior/">« The Lensing Posterior</a><a class="docs-footer-nextpage" href="../04_from_python/">Calling from Python »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.17 on <span class="colophon-date" title="Tuesday 24 May 2022 09:56">Tuesday 24 May 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
